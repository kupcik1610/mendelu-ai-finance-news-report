{% extends 'research/base.html' %}

{% block title %}{{ research.company_name }} - Sentiment Analysis{% endblock %}

{% block content %}
{% if research.status == 'processing' %}
    <!-- Loading State -->
    <div class="max-w-2xl mx-auto text-center py-16">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-6"></div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Analyzing {{ research.company_name }}...</h2>
        <p class="text-gray-600 text-lg mb-4" id="progress-text">{{ research.progress_message|default:"Starting..." }}</p>
    </div>

    <script>
        // Poll for status updates
        setInterval(function() {
            fetch("{% url 'research:status' research.pk %}")
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'completed' || data.status === 'failed') {
                        location.reload();
                    }
                    if (data.progress) {
                        document.getElementById('progress-text').textContent = data.progress;
                    }
                });
        }, 2000);
    </script>

{% elif research.status == 'failed' %}
    <!-- Error State -->
    <div class="max-w-2xl mx-auto text-center py-16">
        <div class="text-red-500 text-6xl mb-6">&#x26A0;</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Analysis Failed</h2>
        <p class="text-gray-600 mb-4">{{ research.error_message }}</p>
        <a href="{% url 'research:index' %}" class="inline-block bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition">
            Try Again
        </a>
    </div>

{% else %}
    <!-- DAILY BRIEFING RESULTS -->

    <!-- Briefing Header -->
    <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-lg shadow-lg p-8 mb-8 text-white">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-gray-400 text-sm uppercase tracking-wide mb-1">Daily Briefing</p>
                <h1 class="text-4xl font-bold">{{ research.company_name }}</h1>
                <p class="text-gray-300 mt-2">{{ research.industry }} | {{ research.created_at|date:"F j, Y" }}</p>
            </div>
            <!-- Sentiment Badge -->
            <div class="text-right">
                <div class="text-6xl font-bold
                    {% if research.sentiment_label == 'positive' %}text-green-400
                    {% elif research.sentiment_label == 'negative' %}text-red-400
                    {% else %}text-gray-400{% endif %}">
                    {% if research.overall_sentiment >= 0 %}+{% endif %}{{ research.overall_sentiment|floatformat:2 }}
                </div>
                <div class="text-lg uppercase tracking-wide
                    {% if research.sentiment_label == 'positive' %}text-green-300
                    {% elif research.sentiment_label == 'negative' %}text-red-300
                    {% else %}text-gray-300{% endif %}">
                    {{ research.sentiment_label }} sentiment
                </div>
            </div>
        </div>
    </div>

    <!-- Two Column Layout: Stock + Key Points -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">

        <!-- Stock Price Card with Chart -->
        {% if research.stock_price %}
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <p class="text-gray-500 text-sm uppercase tracking-wide">Stock Price</p>
                    <p class="text-sm text-gray-400">{{ research.stock_ticker }}</p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-gray-900">${{ research.stock_price }}</div>
                    <div class="flex gap-3 text-sm mt-1">
                        {% if research.stock_change_percent %}
                        <span class="{% if research.stock_change_percent >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            Today: {% if research.stock_change_percent >= 0 %}+{% endif %}{{ research.stock_change_percent }}%
                        </span>
                        {% endif %}
                        {% if research.stock_change_1w %}
                        <span class="{% if research.stock_change_1w >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            1W: {% if research.stock_change_1w >= 0 %}+{% endif %}{{ research.stock_change_1w }}%
                        </span>
                        {% endif %}
                        {% if research.stock_change_1m %}
                        <span class="{% if research.stock_change_1m >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            1M: {% if research.stock_change_1m >= 0 %}+{% endif %}{{ research.stock_change_1m }}%
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Stock Chart -->
            <div class="h-48">
                <canvas id="stockChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Key Developments -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <p class="text-gray-500 text-sm uppercase tracking-wide mb-4">Key Developments</p>
            <ul class="space-y-3">
                {% for dev in research.get_developments %}
                <li class="flex items-start gap-3">
                    <span class="text-blue-500 mt-1">&#8226;</span>
                    <span class="text-gray-700">{{ dev }}</span>
                </li>
                {% empty %}
                <li class="text-gray-500 italic">No recent developments identified</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-6 mb-8">
        <h3 class="text-lg font-semibold text-blue-900 mb-3">Executive Summary</h3>
        <p class="text-blue-800 leading-relaxed text-lg">{{ research.llm_summary }}</p>
    </div>

    <!-- Company Overview -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Company Overview</h3>
        <p class="text-gray-700 leading-relaxed">{{ research.overview }}</p>
    </div>

    <!-- Sentiment Breakdown -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-green-50 rounded-lg p-6 text-center">
            <div class="text-4xl font-bold text-green-600">{{ research.positive_count }}</div>
            <div class="text-green-700 font-medium">Positive Articles</div>
        </div>
        <div class="bg-gray-50 rounded-lg p-6 text-center">
            <div class="text-4xl font-bold text-gray-600">{{ research.neutral_count }}</div>
            <div class="text-gray-700 font-medium">Neutral Articles</div>
        </div>
        <div class="bg-red-50 rounded-lg p-6 text-center">
            <div class="text-4xl font-bold text-red-600">{{ research.negative_count }}</div>
            <div class="text-red-700 font-medium">Negative Articles</div>
        </div>
    </div>

    <!-- News Coverage Section -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">News Coverage</h2>
        <p class="text-gray-600 mb-6">{{ articles.count }} articles analyzed from diverse sources</p>

        <div class="space-y-4">
            {% for article in articles %}
            <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
                <!-- Article Header -->
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <a href="{{ article.url }}" target="_blank"
                           class="text-xl font-semibold text-gray-900 hover:text-blue-600 block mb-2">
                            {{ article.title }}
                        </a>
                        <div class="flex flex-wrap items-center gap-3 text-sm">
                            <!-- Source -->
                            <span class="font-medium text-gray-700">{{ article.source_name|default:article.source }}</span>

                            <!-- Source Type Badge -->
                            <span class="px-2 py-0.5 rounded text-xs font-medium
                                {% if article.source_type == 'major_outlet' %}bg-blue-100 text-blue-700
                                {% elif article.source_type == 'industry_publication' %}bg-purple-100 text-purple-700
                                {% elif article.source_type == 'niche_blog' %}bg-yellow-100 text-yellow-700
                                {% elif article.source_type == 'press_release' %}bg-orange-100 text-orange-700
                                {% else %}bg-gray-100 text-gray-700{% endif %}">
                                {% if article.source_type == 'major_outlet' %}Major Outlet
                                {% elif article.source_type == 'industry_publication' %}Industry Pub
                                {% elif article.source_type == 'niche_blog' %}Niche Blog
                                {% elif article.source_type == 'press_release' %}Press Release
                                {% else %}Unknown{% endif %}
                            </span>

                            <!-- Credibility Indicator -->
                            {% if article.credibility_score %}
                            <span class="text-gray-400" title="{{ article.credibility_note }}">
                                {% if article.credibility_score >= 0.8 %}
                                    <span class="text-green-500">&#9679;&#9679;&#9679;</span>
                                {% elif article.credibility_score >= 0.5 %}
                                    <span class="text-yellow-500">&#9679;&#9679;</span><span class="text-gray-300">&#9679;</span>
                                {% else %}
                                    <span class="text-red-500">&#9679;</span><span class="text-gray-300">&#9679;&#9679;</span>
                                {% endif %}
                                <span class="text-xs text-gray-500 ml-1">credibility</span>
                            </span>
                            {% endif %}

                            {% if article.published_date %}
                            <span class="text-gray-400">|</span>
                            <span class="text-gray-500">{{ article.published_date }}</span>
                            {% endif %}
                        </div>

                        <!-- Credibility Note -->
                        {% if article.credibility_note %}
                        <p class="text-xs text-gray-500 mt-1 italic">{{ article.credibility_note }}</p>
                        {% endif %}
                    </div>

                    <!-- Sentiment Score -->
                    <div class="ml-4 text-center">
                        <div class="text-2xl font-bold
                            {% if article.sentiment_label == 'positive' %}text-green-600
                            {% elif article.sentiment_label == 'negative' %}text-red-600
                            {% else %}text-gray-600{% endif %}">
                            {% if article.ensemble_score >= 0 %}+{% endif %}{{ article.ensemble_score|floatformat:2 }}
                        </div>
                        <div class="text-xs uppercase text-gray-500">sentiment</div>
                    </div>
                </div>

                <!-- Content Preview -->
                {% if article.content_preview %}
                <p class="text-gray-600 text-sm mb-4">{{ article.content_preview }}...</p>
                {% endif %}

                <!-- Model Scores Breakdown -->
                <div class="mt-4 pt-4 border-t">
                    <div class="text-sm text-gray-500 mb-3 font-medium">Sentiment Model Scores</div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <!-- FinBERT -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center gap-1 text-gray-500 mb-1">
                                <span>FinBERT</span>
                                <span class="relative group">
                                    <span class="cursor-help text-gray-400 hover:text-blue-500">&#9432;</span>
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity w-48 pointer-events-none z-10">
                                        Financial domain BERT model trained on financial news. Best at understanding stock/business context. <strong>Weight: 35%</strong>
                                    </span>
                                </span>
                            </div>
                            <div class="font-bold text-lg {% if article.finbert_score >= 0.1 %}text-green-600{% elif article.finbert_score <= -0.1 %}text-red-600{% else %}text-gray-600{% endif %}">
                                {% if article.finbert_score >= 0 %}+{% endif %}{{ article.finbert_score|floatformat:2 }}
                            </div>
                        </div>
                        <!-- VADER -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center gap-1 text-gray-500 mb-1">
                                <span>VADER</span>
                                <span class="relative group">
                                    <span class="cursor-help text-gray-400 hover:text-blue-500">&#9432;</span>
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity w-48 pointer-events-none z-10">
                                        Lexicon-based sentiment. Excellent at detecting intensity, hype, and emotional language from capitalization & punctuation. <strong>Weight: 20%</strong>
                                    </span>
                                </span>
                            </div>
                            <div class="font-bold text-lg {% if article.vader_score >= 0.1 %}text-green-600{% elif article.vader_score <= -0.1 %}text-red-600{% else %}text-gray-600{% endif %}">
                                {% if article.vader_score >= 0 %}+{% endif %}{{ article.vader_score|floatformat:2 }}
                            </div>
                        </div>
                        <!-- RoBERTa -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center gap-1 text-gray-500 mb-1">
                                <span>RoBERTa</span>
                                <span class="relative group">
                                    <span class="cursor-help text-gray-400 hover:text-blue-500">&#9432;</span>
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity w-48 pointer-events-none z-10">
                                        Modern transformer model trained on Twitter/social media. Good at general news sentiment. <strong>Weight: 25%</strong>
                                    </span>
                                </span>
                            </div>
                            <div class="font-bold text-lg {% if article.roberta_score >= 0.1 %}text-green-600{% elif article.roberta_score <= -0.1 %}text-red-600{% else %}text-gray-600{% endif %}">
                                {% if article.roberta_score >= 0 %}+{% endif %}{{ article.roberta_score|floatformat:2 }}
                            </div>
                        </div>
                        <!-- LLM -->
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="flex items-center gap-1 text-gray-500 mb-1">
                                <span>LLM</span>
                                <span class="relative group">
                                    <span class="cursor-help text-gray-400 hover:text-blue-500">&#9432;</span>
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity w-48 pointer-events-none z-10">
                                        Large Language Model (Mistral) providing contextual analysis. Interprets nuance and explains model disagreements. <strong>Weight: 20%</strong>
                                    </span>
                                </span>
                            </div>
                            <div class="font-bold text-lg {% if article.llm_score >= 0.1 %}text-green-600{% elif article.llm_score <= -0.1 %}text-red-600{% else %}text-gray-600{% endif %}">
                                {% if article.llm_score >= 0 %}+{% endif %}{{ article.llm_score|floatformat:2 }}
                            </div>
                        </div>
                    </div>

                    <!-- Ensemble Calculation -->
                    <div class="mt-4 bg-blue-50 rounded-lg p-3">
                        <div class="flex items-center gap-1 text-blue-700 text-sm font-medium mb-2">
                            <span>Ensemble Score Calculation</span>
                            <span class="relative group">
                                <span class="cursor-help text-blue-400 hover:text-blue-600">&#9432;</span>
                                <span class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity w-64 pointer-events-none z-10">
                                    The final score is a weighted average of all models. FinBERT has highest weight (35%) due to financial domain expertise. Score > 0.1 = positive, < -0.1 = negative, else neutral.
                                </span>
                            </span>
                        </div>
                        <div class="text-xs text-blue-600 font-mono bg-white rounded p-2 overflow-x-auto">
                            ({{ article.finbert_score|floatformat:2 }} × 0.35) + ({{ article.vader_score|floatformat:2 }} × 0.20) + ({{ article.roberta_score|floatformat:2 }} × 0.25) + ({{ article.llm_score|floatformat:2 }} × 0.20) = <strong class="{% if article.ensemble_score >= 0.1 %}text-green-600{% elif article.ensemble_score <= -0.1 %}text-red-600{% else %}text-gray-600{% endif %}">{{ article.ensemble_score|floatformat:2 }}</strong>
                        </div>
                    </div>
                </div>

                <!-- LLM Commentary -->
                {% if article.llm_commentary %}
                <div class="bg-gray-50 rounded p-3 mt-3 text-sm text-gray-700">
                    <span class="font-medium">AI Analysis:</span> {{ article.llm_commentary }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Source Diversity Summary -->
    <div class="bg-gray-50 rounded-lg p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Source Diversity</h3>
        <p class="text-gray-600 text-sm mb-4">
            This briefing includes articles from a mix of sources to provide balanced coverage.
            Source credibility is assessed by AI based on publication reputation and content quality.
        </p>
        <div class="flex flex-wrap gap-2">
            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">Major Outlets</span>
            <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">Industry Publications</span>
            <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm">Niche Blogs</span>
        </div>
    </div>

{% endif %}
{% endblock %}

{% block extra_js %}
{% if research.status == 'completed' and research.stock_history %}
<script>
    // Stock price chart
    try {
        const stockData = {{ stock_history_json|safe }};
        if (stockData.dates && stockData.prices && stockData.dates.length > 0) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const isPositive = stockData.prices[stockData.prices.length-1] >= stockData.prices[0];

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: stockData.dates,
                    datasets: [{
                        label: 'Stock Price',
                        data: stockData.prices,
                        borderColor: isPositive ? '#22c55e' : '#ef4444',
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { maxTicksLimit: 5 }
                        },
                        y: {
                            display: true,
                            grid: { color: '#f3f4f6' },
                            ticks: {
                                callback: function(value) { return '$' + value; }
                            }
                        }
                    }
                }
            });
        }
    } catch (e) {
        console.log('Could not render stock chart:', e);
    }
</script>
{% endif %}
{% endblock %}
